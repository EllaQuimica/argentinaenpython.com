# Django models

สิ่งที่เราจะสร้างต่อไปคือ สิ่งที่เราไว้เก็บโพสต์ทั้งหมดในบล็อกของเรา แต่การที่จะทำแบบนั้นเราจะมาทำความรู้จักกับสิ่งหนึ่งที่เรียกว่า `objects`.

## Objects

มีแนวคิดหนึ่งในการเขียนโปรแกรม เรียกว่า `การเขียนโปรแกรมเชิงวัตถุ` แนวคิดนี้ แทนที่เราจะเขียนทุกๆ คำสั่ง ทีละบรรทัดไปเรื่อยๆ แต่เราจะออกแบบบางสิ่งบางอยู่และกำหนดวิธีที่บางสิ่งนี้จะสามารถตอบโต้กันไปมาได้

แล้ว วัตถุ คืออะไร? มันคือชุดของคุณสมบัติและการกระทำ อาจจะฟังดูแปลกๆ แต่เรากำลังจะอธิบายคุณด้วยตัวอย่างนี้

หากเราต้องการสร้างโมเดล Cat เราจะทำการสร้างวัตถุ `Cat` ซึ่งมีคุณสมบัติต่างๆ เช่น: `color`, `age`, `mood` (เช่น good, bad, sleepy ;)), และ `owner` (ซึ่งก็คือวัตถุ `Person` หรือบางกรณีเช่นแมวจรจัด ก็จะไม่มี)

นอกจากนี้ `Cat` สามารถกระทำอะไรบางอย่าง: `purr`, `scratch` หรือ `feed` (ซึ่งเราก็จะให้อาหาร `CatFood`, อาจจะเป็นวัตถุอื่นที่มีคุณสมบัตต่างๆ เช่น `taste`).

    Cat
    --------
    color
    age
    mood
    owner
    purr()
    scratch()
    feed(cat_food)
    
    
    CatFood
    --------
    taste
    

ไอเดียนี้ถูกนำไปใช้ในการอธิบายสิ่งต่างๆ ภายในโค้ด ด้วย คุณสมบัติ (เรียกว่า `object properties`) และ การกระทำ (เรียกว่า `methods`).

แล้วเราจะโมเดลโพสของบล็อกเราอย่างไร? เราต้องการสร้างบล็อก ถูกไหม?

เราต้องตอบคำถามเหล่านี้เสียก่อน: บล็อกโพสต์คืออะไร? ควรมีคุณสมบัติอะไรบ้าง?

แน่นอนว่า บล็อกของเราต้องการข้อความ ทั้งเนื้อหาและชื่อเรื่อง จริงไหม? ถ้าเรารู้ด้วยว่าใครเป็นคนเขียนก็จะดีมาก - ฉะนั้น เราต้องมี ผู้เขียน สุดท้าย เราต้องการรู้ว่า โพสต์เราถูกสร้างและเผยแพร่เมื่อไหร่

    Post
    --------
    title
    text
    author
    created_date
    published_date
    

มีอะไรบ้างที่เราต้องทำเกี่ยวกับบล็อกโพสต์? มันจะดีถ้าเรามี `method` สำหรับเผยแพร่โพสต์ จริงไหม?

ดังนั้น เราต้องการ method `publish`

ตอนนี้เรารู้แล้วว่าสุดท้ายเราต้องการอะไร เรามาเริ่มโมเดลใน Django กัน!

## Django model

การได้รู้ว่าวัตถุคืออะไรแล้ว เราสามารถสร้าง Django model สำหรับบล็อกโพสต์ของเรา

โมเดลใน Django เป็นวัตถุชนิดพิเศษ - ถูกบันทึกลงใน `ฐานข้อมูล` ฐานข้อมูล คือ ชุดของข้อมูล คุณจะเก็บข้อมูลของผู้ใช้ บล็อกโพสต์ของคุณ และอื่นๆ ลงที่นี่ เราจะใช้ฐานข้อมูล SQLite สำหรับเก็บข้อมูลของเรา นี่เป็นการเชื่อมต่อฐานข้อมูลโดยปริยายที่มาพร้อมกับ Django -- ซึ่งเพียงพอสำหรับในตอนนี้

คุณอาจจะคิดได้ว่า โมเดลในฐานข้อมูลคือ ตารางคำนวณที่มี คอลัมน์ (fields) และ แถว (ข้อมูล)

### สร้าง application

เพื่อความเป็นระเบียบเรียบร้อย เราจะสร้าง application ภายใน project ของเรา การจัดระเบียบตั้งแต่เริ่มต้น เป็นสิ่งที่ดีที่ควรทำ การสร้าง application เราต้องรันคำสั่งต่อไปนี้ในคอนโซลของเรา (จากในไดเรกทอรี `djangogirls` ที่มีไฟล์ `manage.py` อยู่ข้างใน):

    (myvenv) ~/djangogirls$ python manage.py startapp blog
    

คุณจะเห็นไดเรกทอรี `blog` เพิ่มขึ้นมา และด้านในก็มีไฟล์อีกจำนวนหนึ่ง ไดเรกทอรีและไฟล์ใน project ของเรา ควรมีประมาณนี้:

    djangogirls
    ├── mysite
    |       __init__.py
    |       settings.py
    |       urls.py
    |       wsgi.py
    ├── manage.py
    └── blog
        ├── migrations
        |       __init__.py
        ├── __init__.py
        ├── admin.py
        ├── models.py
        ├── tests.py
        └── views.py
    

หลังจากสร้าง application เราต้องบอกให้ Django ด้วยว่าเราจะใช้มัน ซึ่งสามารถทำได้ที่ไฟล์ `mysite/settings.py` หาบรรทัด `INSTALLED_APPS` จากนั้นเพิ่มบรรทัด `'blog',` ให้อยู่เหนือเครื่องหมาย `)` ผลลัพธ์สุดท้ายหน้าตาควรจะเป็นแบบนี้:

    python
    INSTALLED_APPS = (
        'django.contrib.admin',
        'django.contrib.auth',
        'django.contrib.contenttypes',
        'django.contrib.sessions',
        'django.contrib.messages',
        'django.contrib.staticfiles',
        'blog',
    )
    

### สร้างโมเดลของบล็อกโพสต์

ในไฟล์ `blog/models.py` เราจะกำหนดวัตถุทั้งหมด เรียกว่า `Models` - ซึ่งเราจะกำหนดบล็อกโพสต์ของเราไว้ที่นี่

เปิดไฟล์ `blog/models.py` และลบทุกอย่างข้างใน และเขียนโค้ดลงไปตามนี้:

    python
    from django.db import models
    from django.utils import timezone
    
    
    class Post(models.Model):
        author = models.ForeignKey('auth.User')
        title = models.CharField(max_length=200)
        text = models.TextField()
        created_date = models.DateTimeField(
                default=timezone.now)
        published_date = models.DateTimeField(
                blank=True, null=True)
    
        def publish(self):
            self.published_date = timezone.now()
            self.save()
    
        def __str__(self):
            return self.title
    

> ตรวจสอบว่าคุณใช้ขีดล่าง (`_`) สองขีดในแต่ละข้างของ `str` รูปแบบนี้เป็นรูปแบบสากลในหมู่ผู้ใช้ Python บางทีก็เรียกพวกมันว่า "dunder" (ย่อมาจาก "double-underscore")

ดูน่ากลัวพิลึก ว่าไหม? แต่ไม่ต้องกังวลไป เราจะอธิบายให้ฟังเอง!

ทุกบรรทัดที่ขึ้นต้นด้วย `from` หรือ `import` คือการหยิบยืมบางส่วนมากจากไฟล์อื่นมาใช้ ดังนั้น แทนที่เราจะคัดลอกและวางสิ่งเดียวกันในทุกไฟล์ เราสามารถใส่บางส่วนโดยใช้ `from ... import ...`.

`class Post(models.Model):` - บรรทัดนี้คือการเริ่มสร้างโมเดลของเรา (มันคือ `object` นั่นเอง).

*   `class` เป็นคำพิเศษ บ่งบอกว่าเรากำลังจะสร้างวัตถุ
*   `Post` เป็นชื่อโมเดลของเรา ซึ่งสามรถตั้งเป็นชื่ออื่นได้ (แต่เราต้องหลีกเลี่ยงการใช้อักขระพิเศษ และ whitespaces) ชื่อ class ขึ้นต้นด้วยตัวอักษรใหญ่เสมอ
*   `models.Model` บอกเราว่า Post คือ Django Model ดังนั้น Django รู้ว่ามันควรถูกบันทึงลงในฐานข้อมูล

ตอนนี้เราจะมากำหนดคุณสมบัติที่เราเคยพูดถึงกัน: `title`, `text`, `created_date`, `published_date` และ `author` เราต้องกดหนดชนิดให้กับแต่ละฟิลด์ (เช่น เป็นข้อความ? หรือ ตัวเลข? วันและเวลา? มีความสัมพันธ์กับวัตถุอื่น เช่น ผู้ใช้ หรือไม่?)

*   `models.CharField` - นี่คือการกำหนดฟิลด์ข้อความที่มีจำนวนอักขระอักษรจำกัด
*   `models.TextField` - เป็นการกำหนดฟิลด์ข้อความที่ความยาวไม่จำกัด เหมาะสำหรับเป็นเนื้อหาในบล็อกโพสต์ ว่าไหม?
*   `models.DateTimeField` - กำหนดฟิลด์วันและเวลา
*   `models.ForeignKey` - มีการเชื่อมโยงไปยังโมเดลอื่น

เราจะไม่อธิบายทุกสิ่งอย่างในโค้ดนี้ เนื่องจากจะใช้เวลานานเกินไป หากคุณต้องการรู้เพิ่มเกี่ยวกับฟิลด์อื่นๆ ที่รองรับในการสร้างโมเดล เราแนะนำให้คุณดูเอกสารจากในโครงการ Django ซึ่งจะมีอธิบายมากกว่าด้านต้น (https://docs.djangoproject.com/en/1.8/ref/models/fields/#field-types)

แล้วส่วนนี้ `def publish(self):` คืออะไร? นี่คือ method `publish` ที่เราเคยบอกไปก่อนหน้านี้นั่นเอง `def` คือ ฟังก์ชัน/method และ `publish` คือชื่อของ method คุณสามารถเปลี่ยนชื่อ method ได้ ถ้าคุณต้องการ การตั้งชื่อจะมีกฎคือ เราจะใช้ตัวพิมพ์เล็กและใช้ขีดล่างแทนช่องว่าง เช่น เรามี method สำหรับคำนวณราคาเฉลี่ย เราจะตั้งชื่อว่า `calculate_average_price`.

Methods ส่วนใหญ่มักจะ `return` บางอย่างออกมา ตัวอย่างเช่นใน method `__str__` ในที่นี้ เมื่อเราเรียก `__str__()` เราจะได้ข้อความ (**string**) ที่เป็นชื่อของโพสต์

ถ้ายังมีข้อสงสัยเกี่ยวกับโมเดล อย่าลังเลที่จะถามโค้ชของคุณนะ! เรารู้ว่ามันมีความซับซ้อนบ้าง โดยเฉพาะเมื่อคุณได้เรียนรู้ทั้ง วัตถุและฟังก์ชัน ในเวลาเดียวกัน หวังว่านี่จะทำให้คุณเข้าใจขึ้นบ้างนะ!

### สร้างตารางสำหรับโมเดลในฐานข้อมูลของคุณ

ขั้นตอนสุดท้ายนี้คือ การเพิ่มโมเดลของเราลงในฐานข้อมูล ก่อนอื่นเราต้องบอกให้ Django รู้ว่าเรามีการเปลี่ยนแปลงในโมเดลของเรา (เราเพิ่งสร้างมันเสร็จไงล่ะ!) ใช้คำสั่ง `python manage.py makemigrations blog` ผลลัพธ์จะคล้ายนี้:

    (myvenv) ~/djangogirls$ python manage.py makemigrations blog
    Migrations for 'blog':
      0001_initial.py:
      - Create model Post
    

Django ได้เตรียมไฟล์ migration ที่จะใช้กับฐานข้อมูลของเรา จากนั้นใช้คำสั่ง `python manage.py migrate blog` และผลลัพธ์ควรจะเป็นดังนี้:

    (myvenv) ~/djangogirls$ python manage.py migrate blog
    Operations to perform:
      Apply all migrations: blog
    Running migrations:
      Rendering model states... DONE
      Applying blog.0001_initial... OK
    

ฮูเร่! โมเดลโพสต์ของเราอยู่ในฐานข้อมูลแล้ว! อยากเห็นข้อมูลข้างในแล้วใช่ไหม? ไปดูกันที่บทถัดไปกันเล๊ย!