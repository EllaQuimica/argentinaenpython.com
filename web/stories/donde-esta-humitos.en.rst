.. title: Where is humitos?
.. slug: donde-esta-humitos
.. date: 2014-11-24 13:50:09 UTC-03:00
.. tags: argentina en python, mapas, blog, python
.. link: 
.. description: 
.. type: text
.. previewimage: preview.jpg

This map is useful to know where I *approximately* am at this moment
and which is my *planned route* for the next days/weeks/months. The
map's goal is :doc:`to be in touch <contacto>` with people next to me
(or my planned route) so we can :doc:`coordinate something related
with the project <eventos>` (or anything of mutual interest) and
organize to see each other in the proximities.

.. raw:: html

   <div id="map"></div>

How this map works?
-------------------

Briefly speaking, when I get connected to the Internet a signal is
sent to this web site with the position where I am at the moment I get
connected, using the Internet connection to know my location.

This process is automatic which allows it to be really up to date with
my current location instead of update it every time I change position
by myself.

----

How this map *exactly* works... ?
---------------------------------

In deep, I use javascript to download the `my-position.json` file
where the coordinates of my current position are and show them into
the map:

.. listing:: donde-esta-humitos/geolocation.js javascript
   :start-line: 144
   :end-line: 162

#. Download `my-position.json`
#. Create the car's icon
#. Add the point inside `my-position.json` to the map
#. Center the map in that position

That `my-position.json` is generated by a Python script:

.. listing:: donde-esta-humitos/geolocation.py python
   :start-line: 163
   :end-line: 196


#. It uses the *geocoder* library to get the coordinates from my current IP
#. It logs all the process to know what happend in case something went wrong
#. Saves the latitude and longitude into `my-position.json`
#. Uploads the new `my-position.json` (with the new coordinates) to
   the server using `scp`

.. note::

   I'm using `time.sleep(WAIT_BEFORE_QUERY)` because I need to wait
   for NetworkManager to get connected to the Internet.

That script is executed by NetworkManager when it's connected to a
network.

.. listing:: donde-esta-humitos/geoblog bash

.. note::

   This script need to be copied in
   `/etc/NetworkManager/dispatch.d/geoblog` and *root* has to be the
   owner of it to be executed by NM.

Basically, it execute the Python script `geolocation.py` if the
interphase is *up*.

.. note::

   It's needed to add *&* to the final of each command because
   `NetworkManager has a bug
   <https://bugzilla.redhat.com/show_bug.cgi?id=982734>`_ that kills
   all the scripts if they have a delay greater than 3 seconds, and
   mine takes more than that because I need to check something on the
   Internet.

That's all!
